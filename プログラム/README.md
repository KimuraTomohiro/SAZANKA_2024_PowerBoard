# SAZANKA電源基板2024 解説　プログラム編
## 概要
この基板にはマイコンがPICマイコンとSeedunoの2系統存在している。それぞれの役割は、

PICマイコン：バッテリーの電圧読み取り，低電圧警告用のLEDとブザーの制御

Seeeduno：リレーの制御，ROSとの連携，CAN通信の制御(オプション)

となっている。PICマイコンとSeeedunoは電源が完全に分かれており、絶縁用ICを使って読み取り電圧の通信を行っている。
この絶縁によって、万が一電源電圧がショートしたり過電圧がかかっても、Seeeduno以降の機器が影響を受けないようになっている。

## PICマイコンのプログラム解説
基本的に[main.c](プログラム/SAZANKA_PowerBoard2024.X/main.c)で完結している。

最初の定数定義部分で、通知電圧、警告電圧、警告のリセット電圧が定義されている。

その後、A_24V,B_24V,A_12V,B_12VはマイコンのADC機能を使って読み取った16ビット値の値を電圧に変換する一次関数の傾きと切片を示している。それらの求め方は下の、電圧変換関数のチューニング方法の章を参照
__バッテリー電圧をチップ抵抗を用いて分圧してマイコンに入力しているが、チップ抵抗にも誤差があるためここの傾きと切片を基板ごとにチューニングしないと正確な電圧が測定できない。この関数を使って求めた電圧をもとに低電圧警告などを行うため、新しい基板を作った際は必ずチューニングすること__

## PICマイコンのプログラムを変更する手順
### 1. MPLAB X IDEを[ダウンロード](https://www.microchip.com/en-us/tools-resources/develop/mplab-x-ide#tabs)&インストール

インストール中に聞かれると思うが、xc8のコンパイラも併せてインストールする

### 2. IDEをインストールするとMPLABXProjectフォルダが作成されるので(ホームディレクトリ？)、その中に`SAZANKA_PowerBoard2024.X`をクローンする

クローン後は、IDEからOpenProjectを指定してクローンしたフォルダを選択して開く

プロジェクト名を右クリックして、Set as main Projectからメインプロジェクトに指定する。
ここで指定したプロジェクトがビルドされる。

### 3. とりあえず何も変更せずにクリーンビルドする
<img width="1552" alt="スクリーンショット 2024-11-19 17 27 43" src="https://github.com/user-attachments/assets/bfef8538-d312-41bc-9771-3a8cee602c53">

画像にあるビルドボタンを押して、BUILD_SUCCESSFULが表示されたら成功。
ビルドに成功したら、プログラムの変えたい部分を変更しながらビルドしていく。

### 4. プログラムが完成したら書き込む
基板上の書込みピンにPICKitを接続する。表面同士を合わせれば自然とピンが合うようになっている

画像にある書込みボタンを押して書き込みを行う

__マイコンに電源電圧がかかっていないと書き込みができない。そのため書き込み時は、21.6V系か10.8V系のどちらかに電源を接続する必要がある。基板から電源を接続せずに書き込みを行う場合は、PICKitから電源を供給する必要がある。その場合、PICKitをPCに接続後、プロジェクト名で右クリックを押して、`Properties > Conf:[default] > PICkit 3 > Option categories > Power` でチェックを付け、電圧レベルを4.5V程度に設定する必要がある__


## 電圧変換関数のチューニング方法
ADC機能の電圧読み取りはPICKitにあるデバッグ機能を使うのが簡単

次の順序で行う

1. プログラムが書き込める状態で、24Vの電源を接続する。この時、安定化電源を使って正確に24Vを供給するか、テスターを使って正確な電圧を測定しておく。安定化電源を使って電圧を供給する場合は、2つのコネクタのうち片方を短絡して、もう片方に電源を接続する。

2. 上の画像のデバッグボタンを押してデバッグモードに入る。すると下のコンソールに変数値を参照できる`Variables`タブができるので、New WatchからADCから読み取った値が格納される`voltage_raw_24`の変数を登録する。

3. 一度デバッグモードを一度Pauseボタンでポーズし、その後Continueボタンでコンティニューする。すると変数値が更新される。変数のValueに値が表示される。初期状態では16進数表記なので、変数の上で右クリックして、Display Value Column AsからDecimalを選択すれば10進数表記になる。電源電圧の値と変数の値をメモする。

4. 安定化電源の電圧を15V程度まで下げ、3番の手順を再度繰り返す。
5. 得られた2組の電源電圧の値と変数の値の組み合わせから、一次関数の傾きと切片の値を計算する。X軸方向に変数の値、Y軸方向に電圧の値を取って計算を行う。
6. 計算した傾きをA_24に、切片をB_24に入れる。
7. 12V側でも同じことを行う。測定は、12Vと7V程度で行い、A_12とB_12に値を代入する。
8. 最後にプログラムの書き込みを行い、動作を確認する。Seeedunoのシリアルポートを使って送られてくる電圧を確認し、大きくずれていないことを確かめる。
